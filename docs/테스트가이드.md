# 테스트 가이드 (SignSense)

본 문서는 수어 인식 프로토타입 서버의 다양한 테스트(기능, 전처리, 성능, 회복력)를 재현 가능한 명령어와 함께 정리합니다.
Windows (cmd.exe) 기준 예시를 사용하며, 다른 OS 는 경로/활성화만 조정하면 됩니다.

---
## 0. 사전 구조
```
SignSense_Server/
  main.py
  smoke_test.py
  processing/landmark_extractor.py
  docs/테스트가이드.md  ← (현재 문서)
  client_test.html
  requirements.txt
```

---
## 1. 가상환경 & 기본 의존성 설치
```bat
python -m venv .venv
.venv\Scripts\activate
pip install --upgrade pip
pip install -r requirements.txt
```
선택 설치 (실제 추론 / 전처리 활성화 필요 시):
```bat
pip install mediapipe==0.10.11 opencv-python numpy
REM (옵션) pip install torch --index-url https://download.pytorch.org/whl/cu121
```

---
## 2. 서버 기동
기본 (landmark 추출 비활성):
```bat
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```
랜드마크 추출 활성:
```bat
set SIGN_EXTRACT_LANDMARKS=1
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```
시퀀스 목표 프레임 변경 (예: 90):
```bat
set SIGN_SEQUENCE_TARGET_FRAMES=90
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```
환경변수 조합:
```bat
set SIGN_EXTRACT_LANDMARKS=1
set SIGN_SEQUENCE_TARGET_FRAMES=72
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

---
## 3. REST 스모크 테스트
서버 기동 상태에서 별도 터미널:
```bat
.venv\Scripts\activate
python smoke_test.py
```
확인 포인트:
- `/` frames_target 값
- `/model/status` is_dummy 여부
- `/simulate/predict` 응답 내 `inference_ms`, `landmarks.enabled`

### landmarks.enabled 확인
- SIGN_EXTRACT_LANDMARKS=0 → `{ "enabled": false }`
- SIGN_EXTRACT_LANDMARKS=1 & mediapipe 설치 → `{ "enabled": true, "seq_shape": [T,147] }`

---
## 4. WebRTC 프레임 전송 테스트 (수동)
1. 브라우저: `http://localhost:8000/client`
2. `Connect` 클릭 (콘솔에 WebSocket 연결 / DataChannel open 로그)
3. `Start Capture` → 프레임 전송 시작 (기본 JPEG)
4. 목표 프레임 도달 시 WebSocket 메시지 `type: result` 수신
5. 강제 조기 결과 필요 시 `Flush` 버튼

체크 항목:
- 콘솔 로그에서 frame count 증가
- result.inference.frames_used == target_frame_count
- landmarks.seq_shape[0] == target_frame_count (활성화 모드)

문제 상황 대응:
| 증상 | 원인 후보 | 조치 |
|------|-----------|------|
| Answer 미수신 | offer 메시지 손상 | 브라우저 devtools network 확인 |
| frames_used < target | 전송 중단/끊김 | Flush 버튼 또는 재연결 |
| landmarks.error | mediapipe 미설치 / 디코딩 실패 | mediapipe 설치, 프레임 형식 확인 |

---
## 5. 랜드마크 전처리 독립 테스트
사전: mediapipe, numpy, opencv-python 설치.
테스트 스크립트(추가): `python test_landmarks.py <이미지1> [이미지2 ...]`
```bat
set SIGN_EXTRACT_LANDMARKS=1
python test_landmarks.py sample1.jpg sample2.jpg
```
출력 예:
```
[OK] frames=2 seq_shape=(2, 147) first_vec_norm=12.345
```
오류 케이스:
- `[WARN] mediapipe/numpy not available` → 의존성 설치 필요
- `[EMPTY] 유효 랜드마크 없음` → skip_missing=True + 모두 미검출

skip_missing 비교 실험:
```bat
python test_landmarks.py sample1.jpg
set SIGN_EXTRACT_LANDMARKS=1
python - <<EOF
from processing.landmark_extractor import RealtimeLandmarkExtractor
# skip_missing False (기본) vs True 차이 체크
EOF
```
(간단히 직접 import 후 특성 길이/None 여부 관찰)

---
## 6. 시퀀스 길이 & 패딩 동작 검증
1) TARGET=60, 실제 전송 40 프레임, Flush:
- 기대: frames_used=40, landmarks.seq_shape=(60,147) (후반 패딩) 또는 skip_missing 로직에 따라 일부 길이 변동 없음 (현재 구현은 add 시 pad 는 build 단계에서 처리)
2) TARGET=90, 실제 120 프레임 전송:
- 기대: landmarks.seq_shape=(90,147) (초과 절단)

---
## 7. 성능 / 지연 측정
(단순 더미모드)
- `/simulate/predict` 반복 호출:
```bat
for /l %i in (1,1,20) do curl -s http://127.0.0.1:8000/simulate/predict > NUL
```
- WebRTC 경로: 브라우저 콘솔에서 `performance.now()` 로 시작~결과 수신까지 측정

추가 측정 아이디어:
| 구간 | 방법 |
|------|------|
| 프레임 수신 지연 | main.py SequenceCollector.receive_first_ts~last_ts |
| 전처리 시간 | landmark_extractor.extract 내부 시간 래핑 (TODO: 로깅) |
| 총 추론 시간 | inference_ms (현재 더미 sleep 포함) |

---
## 8. 에러 & 경계 케이스 체크리스트
| 항목 | 시나리오 | 기대 결과 |
|------|----------|-----------|
| 빈 프레임 수신 | 아무 프레임 없이 Flush | landmarks.seq_shape 누락 또는 error 표시 |
| 손 한쪽만 탐지 | 의도적으로 한 손 가림 | 누락 손 0 패딩 유지 / distance 벡터 일부 0 |
| Pose 미검출 | 상체 화면 밖 | skip_missing=False → 0 벡터, True → 프레임 제거 |
| 과다 프레임 | 목표보다 2배 | 절단 후 처리 (seq_shape 첫 차원 = target) |
| 잘못된 바이트 | 텍스트 전송 | DataChannel on_message 분기에서 무시/에러 없음 |
| mediapipe 미설치 | SIGN_EXTRACT_LANDMARKS=1 | landmarks.enabled True + error 또는 enabled False (import 실패) |

---
## 9. 자동 테스트 / 스크립트 목록
| 스크립트 | 용도 |
|----------|------|
| `smoke_test.py` | 핵심 REST 엔드포인트 응답 확인 |
| `test_landmarks.py` | 단일/다중 이미지로 147차원 특징 추출 검증 |

TODO(추가 가능):
- pytest 기반 유닛 테스트 (`tests/` 디렉토리)
- landmark 시퀀스 통계(평균 norm, 분산) 이상치 감지

---
## 10. 문제 해결 Quick Tips
| 증상 | 해결 |
|------|------|
| ImportError: mediapipe | `pip install mediapipe==0.10.11` |
| landmark seq_shape None | 프레임 디코딩 실패 (이미지 형식/손상) 확인 |
| inference.landmarks.error: seq_none | 모든 프레임 미검출 또는 skip_missing=True | 
| WebRTC 연결 실패 | 방화벽 / HTTPS 필요 / 카메라 권한 확인 |
| frames_used 매우 낮음 | Frame Interval 과 Target 재확인 / 브라우저 탭 비활성화 |

---
## 11. 확장 테스트 아이디어
- FPS 변화(Interval 33ms ↔ 100ms) 시 landmark 품질 비교
- JPEG Quality 0.4~0.9 에 따른 landmark 추출 성공률 측정
- 손 가림 / 조명 변화 / 배경 복잡도 조건에서 추출 실패율 로깅
- 긴 세션(>5분) 메모리 누수 관찰 (psutil 추가 권장)

---
## 12. 차후 자동화 제안
- GitHub Actions: lint + smoke_test (httpx) + 선택적 mediapipe 캐시
- Performance benchmark 스크립트: /simulate/predict 100회 평균
- Landmark drift 모니터: 첫 프레임 대비 손목 상대 거리 분포

---
## 13. 요약
이 문서는 빠른 재현과 팀 내 공통 테스트 기준 확립을 목표로 합니다. 실제 모델 통합 시 전처리/후처리 정확성 검증 케이스(라벨별 샘플 시퀀스 → 예상 로짓/라벨) 섹션을 추가하세요.

문의나 추가 요청 사항은 docs/ 아래에 새 이슈 문서로 확장 가능합니다.

