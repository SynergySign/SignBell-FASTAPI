# 개발 진행 현황 (Progress & Roadmap)

작성일: 2025-10-08  
최종 업데이트: 2025-10-08 (랜드마크 전처리/테스트 가이드 반영)

본 문서는 SignSense Test Server (수어 인식 WebRTC + FastAPI 프로토타입)의 현재 구현 상태, 기술 부채, 남은 과제 및 로드맵을 정리합니다.

---
## 1. 개요
- 목적: 브라우저 → 서버 실시간 프레임(DataChannel) 전송 후 시퀀스 기반 수어 인식 추론.
- 현재 단계: 더미(dummy_infer) + 1차 Landmark 전처리(학습 coordinate_extractor 추정 재현, 147D) 통합.
- 사용 기술: FastAPI, aiortc(DataChannel), WebRTC (브라우저), Python(추론 스텁), Uvicorn, (선택) MediaPipe.

---
## 2. 현재 구현 완료 항목
| 카테고리 | 내용 | 비고 |
|----------|------|------|
| 서버 프레임워크 | FastAPI 앱 기본 구조 | `main.py` |
| 모델 로더 스텁 | torch 있으면 로드 시도, 실패 시 DUMMY_MODEL | 예외 허용, 서비스 지속 |
| WebSocket 시그널링 | Offer 수신 → Answer 생성/전송 (단일 교환) | Trickle ICE 미사용 |
| DataChannel 처리 | 바이너리(JPEG) 프레임 수집 → 목표 개수 도달 시 추론 트리거 | flush 텍스트 강제 처리 지원 |
| 시퀀스 수집 | `SequenceCollector` (프레임, 타이밍 메타) | processed 플래그 1회 처리 |
| 더미 추론 | `dummy_infer` 랜덤 라벨 + 지연 시뮬레이션 | landmarks 메타 포함(옵션) |
| REST 엔드포인트 | `/`, `/health`, `/model/status`, `/config`, `/simulate/predict`, `/client` | HTML 테스트 페이지 |
| 테스트 클라이언트 | `client_test.html` WebRTC + 캡처 + DataChannel 전송 UI | 파라미터 (interval, quality, target) |
| 스모크 테스트 | `smoke_test.py` REST 빠른 점검 | WebRTC 제외 |
| 환경 변수 | `SIGN_SEQUENCE_TARGET_FRAMES` / `SIGN_EXTRACT_LANDMARKS` | 후자는 랜드마크 활성화 |
| Landmark 전처리 1차 | 49 포인트(6 pose + 21L + 21R + 손목거리) *3 = 147D | `processing/landmark_extractor.py` |
| 전처리 통합 훅 | `dummy_infer` 내 선택적 추출/shape 보고 | `SIGN_EXTRACT_LANDMARKS=1` |
| 독립 전처리 테스트 | `test_landmarks.py` 147D 벡터/seq 통계 출력 | skip_missing 옵션 |
| 테스트 가이드 문서 | 명령/절차 종합 정리 | `docs/테스트가이드.md` |
| README 갱신 | 전처리 설명 + 가이드 링크 | 특징 차원/활성화 예시 |

---
## 3. 코드/흐름 간단 다이어그램
```
Browser (client_test.html)
  ├─ getUserMedia -> video
  ├─ RTCPeerConnection.createDataChannel('frames')
  ├─ createOffer + ICE gathering (non-trickle)
  ├─ WebSocket /ws: {action:'offer', sdp}
  ├─ 서버 Answer 수신 -> setRemoteDescription
  ├─ DataChannel open
  ├─ (loop) 캔버스 드로우 → JPEG Blob → ArrayBuffer → dc.send(bytes)
  └─ 목표 프레임 도달 or flush → 서버 result 수신 (WebSocket JSON)

Server (main.py)
  ├─ /ws 수신 → RTCPeerConnection 생성 → setRemoteDescription(Offer)
  ├─ createAnswer → setLocalDescription → Answer 반환
  ├─ on datachannel(message): bytes → collector.add_frame
  ├─ collector.is_ready() == True → dummy_infer 호출
  └─ result JSON WebSocket 전송 (timings + inference)
```

---
## 4. 현재 제한 / 미구현 사항
| 항목 | 상태 | 메모 |
|------|------|------|
| Trickle ICE | 미구현 | 단일 SDP 교환(지연 가능) |
| ICE 후보(양방향) | 미완성 | candidate (클라→서버)만 부분 처리 |
| 실제 모델 추론 | 미구현 | Torch/ONNX 추론 그래프 없음 |
| Landmark 재현 정확도 | 부분 구현 | 학습 코드 원본 대조/검증 필요 |
| 고급 전처리 확장 | 미구현 | visibility, temporal smoothing |
| Chunking/재조립 | 단순 누적 | 헤더 없음 → 손실/순서 취약 |
| 다중 세션 GC | 미구현 | idle timeout 없음 |
| 메트릭/모니터링 | 미구현 | /metrics 없음, in-memory 카운터 미도입 |
| 에러/타임아웃 | 최소 처리 | 재시도/부분 flush 정책 미정 |
| 보안(인증/CORS) | 미구현 | PoC 단계 |
| TLS 자동 구성 | 미구현 | 수동 mkcert 안내만 |
| 테스트 자동화 | 제한 | pytest 없음, 수동+스크립트 위주 |
| 성능 최적화 | 미구현 | MediaPipe 비동기/배치 미적용 |

---
## 5. 우선순위 기반 남은 주요 과제 (업데이트)
| 우선순위 | 작업 | 설명 | 산출물 |
|----------|------|------|--------|
| High | 실제 모델 추론 통합 | Torch/ONNX 로더 + predictor 인터페이스 | predictor 모듈 |
| High | Landmark 정합 검증 | 학습 coordinate_extractor 원본 대비 차이 diff | 검증 스크립트/리포트 |
| High | Chunk 헤더 프로토콜 | seq_id, frame_idx, total, end_flag | 포맷 문서 & 파서 |
| High | 세션 GC & Timeout | idle 세션 정리, 강제 flush/abort | 백그라운드 태스크 |
| Medium | MediaPipe 비동기화 | ThreadPool/ProcessPool, 지연/CPU 개선 | async wrapper |
| Medium | 메트릭 노출 | frames/inference/latency histogram | /metrics 또는 /stats |
| Medium | pytest 기본 도입 | collector / dummy / REST 필드 테스트 | tests/ 디렉토리 |
| Medium | 오류 표준화 | 에러 코드/필드 통일 | error schema 문서 |
| Low | 전처리 고급화 | smoothing, visibility, handedness feature | 옵션 파이프라인 |
| Low | Docker & CI | Dockerfile + GitHub Actions smoke | CI 구성 |
| Low | TURN 연동 | coturn 설정/문서 | 설정 가이드 |
| Low | Adaptive 전송 | fps / quality 동적 조정 스킵 로직 | controller 모듈 |

---
## 6. 단기 실행 계획 (수정)
1. Predictor 인터페이스 초안 정의 (`predictor.py`) + DUMMY / FutureModel 두 구현
2. Landmark 정합 체크 스크립트 (`scripts/compare_landmarks.py`): 저장된 학습 샘플 vs 현재 147D 벡터 diff
3. Chunk 헤더 구조 초안 및 파서 스텁 + 클라이언트 변경 영향 문서화
4. 세션 GC 코루틴 (idle > N초) + 메트릭 카운터(frames_received_total 등) 임시 dict
5. pytest 초기 3~4개 테스트 추가 & 워크플로 배치 (CI skeleton)
6. MediaPipe 추출 비동기 wrapper (ThreadPoolExecutor) 실험 + 평균 처리시간 로깅

---
## 7. 중기 계획 (변경)
- Landmark drift / norm 통계 수집 및 알림
- Temporal smoothing (EMA / sliding median)
- ONNX Runtime 통합 + warmup
- Trickle ICE + candidate 재송신
- Adaptive quality (frame interval / JPEG quality 피드백 루프)
- 오류 표준 JSON 포맷 확정

---
## 8. 장기 로드맵
- 멀티모달(영상 + 센서) 확장 고려
- gRPC bidirectional streaming 비교 벤치마크
- 인식 결과 N-best / 확률 시계열 전달
- 세션 중간 실시간 부분 추론 (슬라이딩 윈도우)
- 모델 버전 롤링 업데이트 전략 / A/B 테스트

---
## 9. 주요 기술 리스크 & 대응 (보강)
| 리스크 | 영향 | 대응 전략 |
|--------|------|-----------|
| 프레임 손실/순서 뒤바뀜 | 추론 정확도 저하 | Chunk 헤더 + frame_idx gap 감지 + 재요청(옵션) |
| MediaPipe 지연 | 전체 레이턴시 상승 | 비동기/배치, 해상도 downscale, 캐시 reuse |
| Landmark 불일치 | 모델 성능 저하 | 원본 학습 스크립트 diff & 재현 테스트 |
| 모델 메모리 사용량 | OOM / 축출 | lazy load + quantization + offload |
| ICE 실패 (NAT) | 연결 불가 | TURN(coturn) 구성 + fallback | 
| 고해상도 과부하 | 대역폭/CPU 증가 | adaptive fps/quality + early drop |
| 단일 프로세스 병목 | 확장성 제약 | 분리 추론 서비스 / multiprocess |

---
## 10. 추후 확장 아이디어 (요약)
- WebRTC Track 수신 후 서버 디코딩 (DataChannel 제외)
- 프레임 Delta 압축 / WebCodecs 활용
- Landmark 빈 영역 sparse encoding
- 결과 스트리밍(프레임 단위 confidence curve)

---
## 11. 메트릭 설계 초안
| 메트릭 | 타입 | 설명 |
|--------|------|------|
| frames_received_total | Counter | 누적 수신 프레임 |
| sequences_completed_total | Counter | 추론 완료된 시퀀스 수 |
| sequence_duration_ms | Histogram | (first_receive ~ last_receive) |
| inference_latency_ms | Histogram | dummy/실제 추론 시간 |
| bytes_received_total | Counter | DataChannel 바이너리 총 바이트 |
| active_peers | Gauge | 현재 RTCPeerConnection 수 |

---
## 12. 테스트 전략 (업데이트)
| 레벨 | 범위 | 예시 |
|------|------|------|
| Unit | SequenceCollector, dummy_infer, landmark extractor | 경계/차원 테스트 |
| Integration | REST 응답 필드 | /simulate/predict, landmarks meta |
| E2E(수동) | WebRTC 흐름 | client_test.html |
| Tool Script | 독립 랜드마크 | `test_landmarks.py` seq norm 검사 |
| Load (후기) | 동시 N peer | Locust / custom script |

---
## 13. 환경 변수 / 설정 (갱신)
| 변수 | 기본 | 설명 |
|------|------|------|
| SIGN_SEQUENCE_TARGET_FRAMES | 60 | 수집 목표 프레임 수 |
| SIGN_EXTRACT_LANDMARKS | 0 | 147D Landmark 전처리 활성화(1) |
| (계획) TURN_URL | - | TURN 서버 주소 |
| (계획) MODEL_PATH | models/... | 모델 경로 재지정 |
| (계획) LOG_LEVEL | info | 런타임 로그 레벨 |

추가 상수: `FRAME_FEATURE_DIM=147` (49 포인트 * 3)

---
## 14. 변경 이력 요약
| 날짜 | 변경 | 비고 |
|------|------|------|
| 2025-10-08 | /client 라우트 + client_test.html 구현, smoke_test 확장 | 초기 WebRTC 수동 테스트 기반 확보 |
| 2025-10-08 | 개발 진행 현황 문서 작성 | 본 문서 최초 작성 |
| 2025-10-08 | Landmark 전처리 모듈(147D), SIGN_EXTRACT_LANDMARKS, test_landmarks.py, 테스트 가이드 추가 | 전처리 1차 통합 |

---
## 15. 다음 권장 액션 (업데이트)
1) Predictor & 실제 모델 추론 경로 골격 작성
2) Landmark 정합 검증 스크립트 + 샘플 diff 리포트
3) Chunk 헤더 포맷/파서 스텁 & 클라이언트 영향 분석
4) 세션 GC + 메트릭 수집 기초 구현
5) pytest/CI 초기 구성
6) MediaPipe 비동기 처리 실험 및 처리시간 통계 로그화

---
문의나 수정 사항은 이 문서 업데이트 후 README 링크 유지 바랍니다.
